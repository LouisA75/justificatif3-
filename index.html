<!doctype html><html lang="fr"><meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<title>Vue s√©curis√©e (15s)</title>
<div id="s" style="padding:10px;font:14px system-ui;color:#999"></div>
<canvas id="cv" style="max-width:100%;background:#000"></canvas>

<!-- OpenPGP.js & PDF.js (compatibles GitHub Pages) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/openpgp/5.11.2/openpgp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";</script>

<script>
(async()=>{
  const S=m=>document.getElementById('s').textContent=m;

  // Bloquer enregistrement/impression contextuels
  document.addEventListener('contextmenu',e=>e.preventDefault());
  document.addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if((e.ctrlKey||e.metaKey)&&(k==='s'||k==='p')) e.preventDefault();
  });

  // Demande du mot de passe (jamais stock√©)
  const pass=prompt('üîê Mot de passe du fichier .gpg :');
  if(!pass){ S('Annul√©'); return; }

  try{
    // Charger le .gpg (reste chiffr√© sur le serveur)
    const r=await fetch('/secure/encrypted.pdf.gpg',{cache:'no-store'});
    if(!r.ok) throw Error('HTTP '+r.status);
    const enc=new Uint8Array(await r.arrayBuffer());

    // D√©chiffrer en m√©moire
    const msg=await openpgp.readMessage({binaryMessage:enc});
    const {data}=await openpgp.decrypt({message:msg,passwords:[pass],format:'binary'});
    enc.fill(0); // effacer le buffer chiffr√©

    // Afficher la 1√®re page (tu peux boucler si besoin)
    const pdf=await pdfjsLib.getDocument({data:new Uint8Array(data),disableFontFace:true}).promise;
    const page=await pdf.getPage(1);
    const cv=document.getElementById('cv');
    const ctx=cv.getContext('2d',{alpha:false});
    const vp=page.getViewport({scale:1.5});
    cv.width=vp.width; cv.height=vp.height;
    await page.render({canvasContext:ctx,viewport:vp}).promise;

    // Message + auto-destruction de la vue en 15 s
    S('Affichage temporaire. Fermeture automatique dans 15 s‚Ä¶');
    setTimeout(()=>{
      try{ cv.width=1; cv.height=1; }catch(_){}
      window.close(); location.replace('about:blank');
    },15000);
  }catch(e){
    S('Erreur : '+e.message);
  }
})();
</script>
</html>
